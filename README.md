# Задание 1 — найди ошибки

В этом репозитории находятся материалы тестового задания "Найди ошибки" для [14-й Школы разработки интерфейсов](https://academy.yandex.ru/events/frontend/shri_msk-2018-2) (осень 2018, Москва, Санкт-Петербург, Симферополь).

Для работы тестового приложения нужен Node.JS v9. В проекте используются [Yandex Maps API](https://tech.yandex.ru/maps/doc/jsapi/2.1/quick-start/index-docpage/) и [ChartJS](http://www.chartjs.org).

## Задание

Код содержит ошибки разной степени критичности. Некоторые из них — стилистические, а другие — даже не позволят вам запустить приложение. Вам нужно найти все ошибки и исправить их.

Пункты для самопроверки:

1. Приложение должно успешно запускаться.
1. По адресу http://localhost:9000 должна открываться карта с метками.
1. Должна правильно работать вся функциональность, перечисленная в условиях задания.
1. Не должно быть лишнего кода.
1. Все должно быть в едином codestyle.

## Запуск

```
npm i
npm start
```

При каждом запуске тестовые данные генерируются заново случайным образом.

# Исправление ошибок

## Ошибка 1

### Описание

На первую ошибку указал сборщик Webpack после запуска команды ```npm start```:

```
WARNING in ./src/index.js 4:2-9
"export 'default' (imported as 'initMap') was not found in './map'
 @ multi (webpack)-dev-server/client?http://localhost:9000 ./src/index.js
```

Из ворнинга следует, что в файле index.js присутствует импорт дефолтного экспорта, которого в импортируемом файле map.js нет.

### Решение

Исправить ошибку можно двумя способами:

1. Исправить экспорт в файле map.js на дефолтный
1. Оставить именованный экспорт в файле map.js и исправить импорт в файле index.js

Так как map.js - это внутренний модуль приложения, его следует привести в соответствие с другими внутренними модулями. В этом приложении используется именованный экспорт, значит следует выбрать второй вариант решения.

## Ошибка 2

### Описание
После исправления первой ошибки Webpack отработал без ошибок, но приложение по-прежнему не появилось в окне браузера. Консоль в Chrome также не показала ошибок в коде, а сообщение ```inited``` из index.js благополучно отобразилось, из чего сдедует, что инициализация карты успешно завершилась. Это указало на то, что следующая ошибка таится где-то в логике, связанной с отображением. Открыв dev tools и взглянув на html, я обнаружил, что в контейнере `#map` действительно появилась разметка карты, а не отображалась она из-за css-правила ```height: 0```, примененного inline к контейнеру карты. При изменении значения этого правила на положительное карта проявилась. Это означало, что где-то в ходе инициализации карты ей задавалась неправильная высота. В документации к API яндекс карт указано, что для инициализации карты нужен [контейнер ненулевого размера](https://tech.yandex.ru/maps/doc/jsapi/2.1/quick-start/index-docpage/#create_map_container), в нашем случае контейнер `#map` имеет нулевую высоту, это значение и используется в ходе инициализации.

### Решение

Для исправления ошибки нужно задать контейнеру `#map` ненулевую высоту. Для этого нужно применить к `#map` css-правило ```height``` с положительным значением. Из описания задания следует, что элемент `#map` должен по ширине и высоте совпадать с вьюпортом браузера. 

Этого можно достичь множеством способов, которые делятся на три основных направления:

1. Задать значения инлайн в файле index.html (например, ```height: 100vh```)
1. Задать значения в файле index.css (например, как в [примерах к документации](https://tech.yandex.ru/maps/jsbox/2.1?from=jsapi) )
1. Задать значения контейнера #map перед инициализацией карты в файле index.js (например, используя значение ```window.innerHeight```)

Первый вариант противоречит принципу разделения разметки и стилизации. Третий вариант добавляет избыточные сущности в javascript приложения для решения задачи, которую можно решить в технологии CSS. Учитывая, что в приложении присутствует специальный файл index.css, который содержит все основные css-правила, самым логичным решением представляется вариант 2.

## Ошибка 3

### Описание
Следующий пункт описания задания гласит: 
```На карте отображаются места размещения базовых станций.```
На данном этапе этого явно не происходит. Ошибок в консоли не прибавилось, нужно изучать код и разбираться в логике. Из просмотра файла map.js, в котором осуществляется инициализация карты столо понятно, что за размещение базовых станций отвечает объект ```objectManager```, создаваемый конструктором ```map.ObjectManager```. Этот объект инициализируется, наполняется данными, но не добавляется на карту.

### Решение
Согласно документации [Объект ObjectManager расширяет объект (интерфейс) IGeoObject](https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/ObjectManager-docpage/). Такие объекты добавляются в коллекцию геообъектов инстанса карты методом [map.GeoObjects.add](https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/map.GeoObjects-docpage/). Таким образом, в файл map.js нужно добавить код, который свяжет инстанс карты с инстансом ```ObjectManager``` после полной инициализации последнего.

## Ошибка 4

### Описание
Теперь объекты отображаются на карте и объединяются в кластеры. При клике на кластер карта масштабируется и показывает объекты, принадлежащие этому кластеру. Но при попытке масштабировать карту обратно приложение `зависает` и в консоле начинают возникать ошибки типа
```Uncaught TypeError: Cannot read property 'setPosition' of null```
```Uncaught TypeError: Cannot read property 'getCurrentState' of null```, возникающие в скриптах API яндекс карт.
Воспроизвести ошибку на регулярной основе не удаётся. Поиск в яндекс по запросу 'yandex maps api Uncaught TypeError: Cannot read property ''setposition'' of null' ничего толкового не выдаёт. Только [намёк на то, что это может быть связано с кластеризацией](https://toster.ru/q/207601). Пока иду дальше.

### Решение
Решено вместе с Ошибкой 6.

## Ошибка 5

### Описание
Очередной подпункт описания: `Если неисправный объект входит в кластер, то иконка кластера должна показывать, что в нем есть неисправная станция`. Сейчас все кластеры обозначены одинаково. Вероятно, что-то пошло не так :) Отправляюсь читать доки по кластерам.

### Решение
Все кластеры окрашены в зелёный, так как в файле map.js для них используется дефолтный пресет ```'islands#greenClusterIcons'```. Нужно поменять этот пресет, например, на ```'islands#redClusterIcons'``` для тех кластеров, в которых есть неактивные станции. [Согласно документации](https://tech.yandex.ru/maps/doc/jsapi/2.1/dg/concepts/object-manager/frontend-docpage/#clusterize__object-cluster-structure), этого можно достигнуть, подписавшись на событие создания кластера, и, получив доступ к коллекции геообъектов этого кластера и проверив, есть ли среди них неактивные станции, изменить для такого кластера пресет.
Так как весь код, имеющий отношение к кластерам, расположен в файле map.js, необходимый для решения проблемы код также целесообразно разместить в этом файле. Логично поместить его под строкой, задающий дефолтный пресет для всех кластеров.

## Ошибка 6

### Описание
Пункт описания `При клике на метку базовой станции появляется попап с информацией о ней: серийный номер, координаты, состояние, количество активных дронов, график нагрузки.` также не выполняется. При клике на метку станции, информационный балун открывается не над объектом, а в левом верхнем углу карты. Макет, задаваемый балуну в файле details.js не рендерится. Ошибок в консоли при клике не возникает. При дальнейшем взаимодействии с картой возникает сценарий ранее описанный как 'Ошибка 4'.

### Решение
Чтобы разобраться, почему не рендерится содержимое балуна, нужно изучить код в файле details.js, который экспортирует функцию, которая возвращает конструктор макета. Для создания шаблона макета использована фабрика ```templateLayoutFactory```. Первым аргументом она принимает шаблон, вторым - объект с методами базового класса, которые нужно переопределить. Если передавать в эту фабрику только первый аргумент, то балун начинает отображаться в нужном месте и с частью контента, значит ошибка где-то в переопределяемых методах. Действительно, для переопределения методов были использованы стрелочные функции, которые лексически привязаны к значению this, то есть используют значение this из окружающего контекста. Значение this для окружающего стрелочную функцию контекста, в нашем случае, явно не задано. Код, заключённый в ES2015-модули автоматически обрабатывается в 'strict mode'. Следовательно, this в наших стрелочных функциях получает значение ```undefined```. Разумеется, такое поведение приводит к ошибке, так как подразумеваемое значение this – это инстанс макета. Значит, чтобы устранить ошибку, нужно обеспечить правильное значение this внутри переопределяемых методов. Для этого достаточно вместо стрелочных функций использовать анонимные функциональные выражения, которые унаследуют значение this от вызывающего их объекта (инстанса макета).

## Ошибка 7

### Описание
При изучении файла details.js, я обнаружил, что в шаблоне макета не хватает закрывающего тега ```</div>```.

### Решение
Добавить закрывающий тег в шаблон.

## Ошибка 8

### Описание
По-прежнему пункт описания `При клике на метку базовой станции появляется попап с информацией о ней: серийный номер, координаты, состояние, количество активных дронов, график нагрузки.` На попапе не отображаются координаты станции и график нагрузки пустует у активных станций. В этой ошибке будет исправлено отображение координат.

### Решение
Значения координат доступны на объекте `properties.details`, который передаётся в шаблон макета, значит можно сразу добавить в шаблон разметку, выводящую координаты на попап. Шаблон макета находится в файле details.js. Подходящее место для координат находится под серийным номером на отдельной строке. Координаты можно вывести в принятом в Яндекс Картах формате: "lat, long". Также, для того, чтобы координаты вписывались в общий стиль попапа, можно добавить класс `details-location` к элементу, содержащему координаты, и добавить несколько css-правил для этого класса в файл index.css.

## Ошибка 9

### Описание
Прежде чем перейти к следующей ошибке на попапе, я исправлю ошибку, которую следовало исправить как можно раньше, так как это сэкономило бы время при тестировании пользовательского интерфейса вручную. Но, лучше поздно, чем никогда. Нет никакого смысла продолжать зумить и двигать карту, отыскивая затерявшиеся в Голестане станции.

### Решение
На бэкэнде широта и долгота формируется и отправляется корректно, значит ошибка где-то в принимающем коде на фронтэнде. За получение списка геостанций с сервера отвечает функция `loadList` из файла api.js. Она отправляет запрос на сервер и обрабатывает ответ с помощью функции `mapServerData` из файла mappers.js. Функция `mapServerData` формирует объект `FeatureCollection` согласно требованиям метода `ObjectManager.add`. Координаты геообъекта должны задаваться через свойство `geometry.coordinates`, для [Базовой геометрии "Точка"](https://tech.yandex.ru/maps/doc/jsapi/2.1/ref/reference/geometry.base.Point-docpage/) значение должно быть массивом чисел в формате `[lat, long]`. В функции `mapServerData` этому свойству присваивается массив чисел, но широта и долгота перепутаны местами. Cоответственно, для того, чтобы исправить ошибку, достаточно в `mapServerData` верно задавать значение свойства `geometry.coordinates`.

## Ошибка 10

### Описание
В пункте описания `При клике на метку базовой станции появляется попап с информацией о ней: серийный номер, координаты, состояние, количество активных дронов, график нагрузки.` Осталось одно невыполненное требование: график нагрузки пустует у активных станций.

### Решение
Код, отрисовывающий графики, находится в файле chart.js. При беглом просмотре объекта с настройками, передаваемого для инициализации графика конструктору `Chart`, я заметил, что значение свойства `options.scales.yAxes.ticks.max` равно нулю. Это показалось мне странным, так как соседнему свойству `options.scales.yAxes.ticks.beginAtZero` установлено значение `true`. Логично предположить, что эти свойства отвечают за начало и конец оси Y графика, а если ось Y начинается нулём и заканчивается нулём, то единственный точки, которые можно расположить на графике - те, у которых значение по оси Y равно нулю. Так как по оси Y на графике располагается нагрузка станции (количество связей), нагрузка должна отображаться только для неактивных станций, что очень похоже на нашу ошибку. Обратившись к документации, я выяснил, что вышеупомянутое свойство `options.scales.yAxes.ticks.max` [заменяет собой максимальное значение, полученное на основании переданных данных](http://www.chartjs.org/docs/latest/axes/cartesian/linear.html#axis-range-settings), значит для решения достаточно удалить свойство `options.scales.yAxes.ticks.max` из объекта настроек графика.

# Code quality
Теперь, когда приложение соответствует всем пунктам описания, можно считать, что все ошибки, мешающие работе приложения, исправлены.
Для обеспечения единого code-style в приложении разумно использовать линтер. Например, [semistandard](https://github.com/Flet/semistandard), который достаточно распространён. После запуска команды `semistandard --fix` остались только 5 ошибок:
```
  /Users/patat/Documents/code/shri/entrance-task-1-2/src/api.js:4:10: 'fetch' is not defined.
  /Users/patat/Documents/code/shri/entrance-task-1-2/src/api.js:10:10: 'fetch' is not defined.
  /Users/patat/Documents/code/shri/entrance-task-1-2/src/index.js:3:1: 'ymaps' is not defined.
  /Users/patat/Documents/code/shri/entrance-task-1-2/src/index.js:4:11: 'ymaps' is not defined.
  /Users/patat/Documents/code/shri/entrance-task-1-2/src/popup.js:41:5: 'htmlInfo' is not defined.
```
Все эти ошибки относятся к правилу eslint [Disallow Undeclared Variables (no-undef)](https://eslint.org/docs/rules/no-undef). Первые четыре из них решаются добавлением комментариев `/* global fetch */` и `/* global ymaps */` в файлы api.js и index.js соответственно. Есть и другие способы решения проблемы глобальных переменных в контексте eslint:
1. Можно добавить ключ `globals` в файл package.json и перечислить под ним все используемые в коде глобальные переменные
1. Или можно использовать тот факт, что глобальные переменные - это свойства суперглобального объекта, использование которого допускается правилами eslint. То есть использовать `window.fetch` и `window.ymaps`.
Я выбрал вариант с использованием комментария, так как: 
1. в отличие от первой альтернативы, он явно указывает используемые глобальные переменные в файле с кодом, в котором они используются. 
1. в отличие от второй альтернативы, не требует изменять сам код.

Что касается пятой ошибки из списка semistandard, то она возникает в файле, который не используется в приложении и содержит код, который врядли пригодится в будущем. А значит, вместо того, чтобы исправлять ошибку, можно удалить сам файл.




